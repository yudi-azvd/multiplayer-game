<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multiplayer Game</title>
  <link rel="icon" href="./icon.ico">

  <style>

    .container {
      display: flex;
      justify-content: center;
    }

    #screen {
      border: 10px solid #ccc;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      image-rendering: -moz-crisp-edges;
      
      width: 400px;
      height: 400px;
      margin-right: 5px;
    }

    #info {
      width: 200px;
      display: block;
      padding: 5px;
      border: 2px dashed #ccc;
    }

  </style>
  <script src="/socket.io/socket.io.js" ></script>
</head>
<body>

  <div class="container">
    <canvas id="screen" width="10" height="10"></canvas>
    <div id="info">
      <p>
        Your id: <span id="playerId"></span>
      </p>  
      <p>
        Score: <span id="playerScore">0</span>
      </p>  
    </div>
  </div>

  <!-- 
    Um bloco de script pra importar um módulo
    também precisa ser um módulo 
  -->
  <script type="module" >
    import createGame from './game.js'
    import createKeyboardListener from './keyboardListener.js'
    import renderScreen from './screen.js'

    const collect = new Audio('./collect.mp3')
    const collect100 = new Audio('./100-collect.mp3')

    const game = createGame()
    const keyboardListener = createKeyboardListener(document)

    const socket = io()

    socket.on('connect', (state) => {
      const playerId = socket.id
      console.log(`Current Player: ${playerId}`)
      
      const score = document.getElementById('playerId')
      score.innerText = playerId

      const screen = document.getElementById('screen')
      renderScreen(screen, game, requestAnimationFrame, playerId)
    })

    socket.on('setup', state => {
      const playerId = socket.id
      game.setState(state)

      keyboardListener.registerPlayerId(playerId)
      keyboardListener.subscribe(game.movePlayer)
      keyboardListener.subscribe(command => {
        socket.emit('move-player', command)
      })
    })

    socket.on('add-player', command => {
      game.addPlayer(command)
    })
    
    socket.on('remove-player', command => {
      game.removePlayer(command)
    })
    
    socket.on('move-player', command => {
      const playerId = socket.id
      console.log(`Receiving ${command.type} -> ${command.playerId}`)

      if (command.playerId !== playerId) {
        game.movePlayer(command)
      }
    })

    socket.on('add-fruit', command => {
      game.addFruit(command)
    })
    
    socket.on('remove-fruit', command => {
      const playerId = socket.id
      const player = game.state.players[playerId]
      const playerScore = document.getElementById('playerScore')
      
      // não parece muito seguro: comparação direta com elemento da DOM
      if (playerScore.innerText !== String(player.score)) {
        console.log( 'DIFF', playerScore.innerText, player.score)
        playerScore.innerText = player.score

        // desse jeito não há tracking INDIVIDUAL de pontos
        // score não é necessariamente incrementado em 1
        // outro jeito: os dois números são de centenas diferentes?
        player.score % 100 === 0 ? collect100.play(): collect.play()
      }
      
      console.log('Receiving remove-fruit', command.fruitId, playerId)

      game.removeFruit(command)
    })
    
  </script>
</body>
</html>