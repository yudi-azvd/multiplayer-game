<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multiplayer Game</title>

  <style>
    #screen, #screen2 {
      border: 10px solid #ccc;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      image-rendering: -moz-crisp-edges;

      width: 400px;
      height: 400px;
    }
  </style>
  <script src="/socket.io/socket.io.js" ></script>
</head>
<body>
  <canvas id="screen" width="10" height="10"></canvas>
  
  <canvas id="screen2" width="10" height="10"></canvas>

  <!-- 
    Um bloco de script pra importar um módulo
    também precisa ser um módulo 
  -->
  <script type="module" >
    import createGame from './game.js'
    import createKeyboardListener from './keyboardListener.js'
    import renderScreen from './screen.js'

    const game = createGame()
    const keyboardListener = createKeyboardListener(document)

    const screen = document.getElementById('screen')
    const context = screen.getContext('2d')
    console.log(context.getImageData(0, 0, 10, 10))


    // const s = document.getElementById('2s')
    // console.log(screen.)
    const socket = io()

    socket.on('connect', (state) => {
      console.log(`Current Player: ${socket.id}`)

      renderScreen(screen, game, requestAnimationFrame, socket.id)
    })

    socket.on('setup', state => {
      const playerId = socket.id
      game.setState(state)

      keyboardListener.registerPlayerId(playerId)
      keyboardListener.subscribe(game.movePlayer)
      keyboardListener.subscribe(command => {
        socket.emit('move-player', command)
      })
    })

    socket.on('add-player', command => {
      game.addPlayer(command)
    })
    
    socket.on('remove-player', command => {
      game.removePlayer(command)
    })
    
    socket.on('move-player', command => {
      const playerId = socket.id

      const screen2 = document.getElementById('screen2')
      const context2 = screen2.getContext('2d')

      // https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas
      // https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/putImageData
      /* Pensando bem, talvez não seja uma boa copiar _todo_ o canvas a cada modificação
      Algumas coisas no canvas não mudam, então não precisam ser atualizadas */
      console.log(context.getImageData(0, 0, 10, 10))
      context2.putImageData(context.getImageData(0, 0, 10, 10), 0, 0)


      if (command.playerId !== playerId) {
        game.movePlayer(command)
      }
    })

    socket.on('add-fruit', command => {
      game.addFruit(command)
    })
    
    socket.on('remove-fruit', command => {
      game.removeFruit(command)
    })
    
  </script>
</body>
</html>